name: CI (Kubernetes Manifests)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          curl -sSL -o kubeconform.tar.gz 
https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform.tar.gz kubeconform
          sudo mv kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: YAML lint
        run: |
          yamllint -d "{extends: default, rules: {line-length: disable}}" k8s

      - name: K8s schema validation (kubeconform)
        run: |
          kubeconform -strict -summary -ignore-missing-schemas k8s/**/*.yaml

      - name: Repo sanity checks
        run: |
          test -d k8s
          test -f k8s/namespace.yaml
          test -f k8s/deployment.yaml
          test -f k8s/service.yaml
          echo "OK âœ…"

